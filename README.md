# Patrol-car-openmv-
All codes for the on campus electric racing patrol car

详细报告在文件中，部分预览如下：

摘要
一、系统方案
1.技术路线
    我们队伍利用Openmv系列的M4PLUS摄像主控板，配合PID算法，便可以实现小车的循迹功能。另外，Openmv系列主控板的函数库拥有多样的函数，其中通过findblock()函数，配合算法分析与条件判断，便可以实现“ T“字路口的识别判断。最后，我们利用超声波模块测得小车与目标物和障碍物的距离。
    我们队伍小车的硬件系统结构，如图1，图2和图3所示。从图1所展示的，我们队伍将Openmv以及超声波测距模块安装在小车的正面，有利于小车正确识别到黑色循迹线和测定距离。从图2所展示的，我们队伍利用一双木筷子将Openmv支起，为了使摄像头向下45°，更好地让摄像头观察到循迹线，也为了更好调节PID巡线的参数。从图3所展示的，我们将稳压模块，驱动模块放置在小车的第二层，方便我们在后期调整杜邦线。

2.方案论证
    在我们测试中，稳压模块和驱动模块等其他模块测试正常。小车安装的Openmv很好地识别到黑线，然后通过事先写好的PID算法能够短暂循迹行走一段路程，证明我们安装Openmv的角度与距离都十分合适。然后我们在小车前方放置目标物，然后我们比较通过超声波模块测定小车与目标物的距离和我们用直尺测定的距离，误差结果在我们可接收的范围内，证明超声波模块的功能没问题和位置正确。最后我们确定了方案的可行性与正确性。
    重点讲一下，驱动模块和超声波模块的工作原理。驱动模块引脚展示如图5所示。AIN1和2以及BIN1和2为两个电机的控制端，在AIN1和2分别为高电平或低电平便可以去驱动A电机转动。驱动模块的重要点在于PWMA和PWMB两个引脚，在输入不同占空比的方波信号后，如图4所示，会调节电机的启动时间，这就让电机实现了变速功能。最后是电源的接入，VCC和STBY接入3.3V，VM接入电机电源12V，这就可以驱动电机转动了。
    然后，超声波模块的工作原理，大致如下：首先在Echo口输入10ms的高电平方波信号，然后超声波模块便会发送8个方波信号，若前方有障碍物，则方波信号会反弹回到模块并被接收。在接收前，Trig一直输出低电平，直到接收到方波信号后，才输出高电平，接收完毕后会重新输出低电平。我们只需设置定时器采集高电平的维持次数k，然后因为Openmv的晶振频率为480MHz，则可以通过下面公式计算时间
t = k * (1 / 480MHz) * 340 m/s /2

三、电路与程序设计
1.电路设计与参数计算
由于本次比赛提供的小车组件都为模块化，所以只需要简单连线即可。锂电池提供电源，接入稳压模块后再输出12V，5V和3.3V，然后分别作为两个驱动电机，Openmv和超声波模块，蜂鸣器的电源电压。Openmv的P5,P6接口接入到分别接入到超声波模块的Echo和Trig。Echo的作用为当Openmv发送一个10ms的高电平时，便会发送8个方波来测定距离。而Trig则作为接收方波，确定传播时间，最后在主控芯片里面完成计算距离。Openmv的P9接口则作为蜂鸣器的控制端。驱动模块在接入电源电压后，需要接入两个控制端，一个PWM波才可以控制一个电机。所以Openmv的P1,2,3以及8作为四个控制端，而P6和P7则输出PWM波来控制方波的占空比，以控制电机的速度。
2.执行机构控制算法与驱动
重点讲解Openmv的循迹和识别岔口这两方面的工作原理与计算。Openmv的循迹运用到PID算法，而这算法的关键在于怎么调节PID这三个参数的值，我们一般会先确定比例增益P 时，首先去掉PID的积分项和微分项，一般是令Ti=0、Td=0，使PID为纯比例调节。输入设定为系统允许的最大值的60%~70%，由0逐渐加大比例增益P，直至系统出现振荡；再反过来，从此时的比例增益P逐渐减小，直至系统振荡消失，记录此时的比例增益P，设定PID的比例增益P为当前值的60%~70%。比例增益P调试完成。然后比例增益P确定后，设定一个较大的积分时间常数Ti的初值，然后逐渐减小Ti，直至系统出现振荡，之后在反过来，逐渐加大Ti，直至系统振荡消失。记录此时的Ti，设定PID的积分时间常数Ti为当前值的150%~180%。积分时间常数Ti调试完成，最后的Td一般为0即可。具体代码如下图8：
3.测试数据
①黑色巡线的色彩阈值为：GRAYSCALE_THRESHOLD = [(-125, 20, -21, 13, -28, 14)]
	参数含义为（线长度min,线长度max，颜色Amin，颜色Amax，颜色Bmin，颜色Bmax）
②摄像头需捕捉的像素范围：ROIS = [(0, 23, 60, 5, 0.7)]
参数含义为（x坐标，y坐标，长度，宽度，权重）
③小车的行进速度比值：全速的25%
4.测试结果分析
一开始我们用Openmv实时拍摄循迹线的照片，然后将其转为灰度二值化的图片，即将需要的颜色——黑色，转化为白色，而其他颜色则转为为黑色。我们在网上查阅到准确的黑色阈值，即-21<A<13，-28<B<14。这样在摄像头显示的便是清晰的跑道
然后，岔口识别的分析，我们也是用的Openmv实时拍摄循迹线的照片，但与前面不同的是，这次只需对全彩的照片进行分析即可。我们在测试发现，只要对全彩照片的上面三分之一的区域敏感捕捉。于是我们设置捕捉坐标为（0，23），即在照片第0行，第23列的像素为捕捉中心点，然后在设置捕捉范围为（60，5），即在中心点附近长为60像素点，宽为5像素点的范围进行捕捉识别。这样便可以准确识别到岔口。、
